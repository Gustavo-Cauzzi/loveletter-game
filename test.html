<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script
      src="https://code.jquery.com/jquery-3.6.2.js"
      integrity="sha256-pkn2CUZmheSeyssYw3vMp1+xyub4m+e+QK4sQskvuo4="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
  </head>
  <body style="background: black">
    <script type="importmap">
      {
        "imports": {
          "socket.io-client": "https://cdn.socket.io/4.4.1/socket.io.esm.min.js"
        }
      }
    </script>

    <script type="module" defer>
      import { io } from 'socket.io-client';

      const api = axios.create({
        baseURL: 'http://localhost:3333',
        headers: {},
      });

      api.interceptors.response.use(
        resp => resp,
        error => {
          if (error.response?.status >= 400) {
            alert(error.response.data.message);
          }
        },
      );

      let socket;

      function updateSocketEvents() {
        socket.on('/rooms/new', payload => {
          console.log('/rooms/new', payload);
          document.getElementById('list').innerHTML += createRoomRow(payload);
        });

        socket.on('/rooms/update', room => {
          console.log('/rooms/update: ', room);
          updateRoom(room);
        });

        socket.on('connect', () => {
          console.log('Socket novo conectado');
        });

        socket.on('disconnect', () => {
          alert('Socket desconectado');
          location.reload();
        });
      }

      function updateRoom(room) {
        const roomEl = document.querySelector(`div[data-roomId="${room.id}"]`);
        if (!roomEl) {
          alert(`Sala de id ${room.id} n√£o encontrada`);
          return;
        }

        //prettier-ignore
        roomEl.innerHTML = `
          ${room.name} ${room.numberOfPlayers}/2
          <button ${room.numberOfPlayers === 2 ? 'disabled' : ''} onclick="joinRoom('${room.id}')">
            entrar
          </button>
        `
      }

      async function createRoom(event) {
        console.log('criando sala');

        const response = await api
          .post('/rooms', { name: $('#create').val() })
          .catch(err => alert(err));

        console.log('Sala criada', response.data);

        document.getElementById('list').innerHTML += createRoomRow(
          response.data,
        );
      }

      //prettier-ignore
      const createRoomRow = room =>
        `<div data-roomId="${room.id}">
          ${room.name} ${room.numberOfPlayers}/2
          <button ${room.numberOfPlayers === 2 ? 'disabled' : ''} onclick="joinRoom('${room.id}')">
            entrar
          </button>
        </div>`;

      async function joinRoom(roomId) {
        const response = await api.patch('/rooms/join', { roomId });
        updateRoom(response.data);
      }

      async function getGames() {
        const response = await api.get('/rooms');
        document.getElementById('list').innerHTML = response.data
          .map(createRoomRow)
          .join('');
      }

      async function logInto(event, username) {
        const token = await axios
          .post('http://localhost:3333/users/login', {
            username: username,
            password: '123123',
          })
          .then(res => res.data.token);

        api.defaults.headers = { Authorization: `Baerer ${token}` };
        socket = io('ws://localhost:3333', {
          auth: {
            Authorization: `Baerer ${token}`,
          },
        });

        console.log('socket: ', socket);

        updateSocketEvents();
        getGames();

        document.getElementById('content').style.display = 'block';
        document.getElementById('login').style.display = 'none';
        document.getElementById('currentUsername').innerHTML = username;
      }

      window.createRoom = createRoom;
      window.joinRoom = joinRoom;
      window.logInto = logInto;
    </script>

    <div id="login">
      <button onclick="logInto(event, 'Gustavo')">Logar Gustavo</button>
      <button onclick="logInto(event, 'Gustavo1')">Logar Gustavo1</button>
    </div>

    <div id="content" style="display: none">
      <span
        style="display: block; color: white; margin-bottom: 10px"
        id="currentUsername"
      ></span>
      <button onclick="createRoom(event)">Criar sala</button>
      <input type="text" placeholder="Nome da sala" id="create" />

      <div
        id="list"
        style="color: white; display: flex; flex-direction: column; gap: 15px"
      ></div>
    </div>
  </body>
</html>
